// ğŸ“ íŒŒì¼: prisma/schema.prisma
// Prisma ìŠ¤í‚¤ë§ˆ ì •ì˜ - SQLite ë²„ì „

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ì‚¬ìš©ì ëª¨ë¸
model User {
  id            String          @id @default(cuid())
  discordId     String          @unique
  username      String
  discriminator String?
  avatar        String?
  email         String?
  permissions   String          @default("[]") // SQLiteëŠ” ë°°ì—´ì„ ì§€ì›í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ JSON ë¬¸ìì—´ë¡œ ì €ì¥
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  
  // ê´€ê³„
  parties       Party[]         @relation("PartyCreator")
  partyMembers  PartyMember[]
  commandLogs   CommandLog[]
  apiLogs       APILog[]
  
  @@index([discordId])
}

// ê¸¸ë“œ ëª¨ë¸
model Guild {
  id              String          @id @default(cuid())
  guildId         String          @unique
  name            String
  icon            String?
  memberCount     Int             @default(0)
  ownerId         String
  joinedAt        DateTime
  features        String          @default("[]") // JSON ë¬¸ìì—´ë¡œ ì €ì¥
  preferredLocale String?
  settings        String          @default("{}") // JSON ë¬¸ìì—´ë¡œ ì €ì¥
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  // ê´€ê³„
  parties         Party[]
  commandLogs     CommandLog[]
  
  @@index([guildId])
}

// íŒŒí‹° ëª¨ë¸ (ê²Œì„ íŒŒí‹°)
model Party {
  id          String          @id @default(cuid())
  guildId     String
  guild       Guild           @relation(fields: [guildId], references: [guildId], onDelete: Cascade)
  creatorId   String
  creator     User            @relation("PartyCreator", fields: [creatorId], references: [id])
  
  title       String
  game        String
  description String?
  maxMembers  Int             @default(4)
  startTime   DateTime
  endTime     DateTime?
  status      String          @default("ACTIVE") // ACTIVE, COMPLETED, CANCELLED
  
  channelId   String?
  messageId   String?
  voiceChannelId String?
  
  metadata    String          @default("{}") // JSON ë¬¸ìì—´ë¡œ ì €ì¥
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  
  // ê´€ê³„
  members     PartyMember[]
  
  @@index([guildId, status])
  @@index([creatorId])
  @@index([startTime])
}

// íŒŒí‹° ë©¤ë²„ ëª¨ë¸
model PartyMember {
  partyId   String
  party     Party     @relation(fields: [partyId], references: [id], onDelete: Cascade)
  userId    String
  user      User      @relation(fields: [userId], references: [id])
  
  role      String    @default("MEMBER") // LEADER, MEMBER
  joinedAt  DateTime  @default(now())
  
  @@id([partyId, userId])
  @@index([userId])
}

// ëª…ë ¹ì–´ ë¡œê·¸ ëª¨ë¸
model CommandLog {
  id           String    @id @default(cuid())
  command      String
  userId       String
  user         User      @relation(fields: [userId], references: [id])
  guildId      String?
  guild        Guild?    @relation(fields: [guildId], references: [guildId])
  channelId    String?
  success      Boolean   @default(true)
  errorMessage String?
  executedAt   DateTime  @default(now())
  
  @@index([userId])
  @@index([guildId])
  @@index([executedAt])
}

// API ë¡œê·¸ ëª¨ë¸
model APILog {
  id         String    @id @default(cuid())
  method     String
  path       String
  statusCode Int
  userId     String?
  user       User?     @relation(fields: [userId], references: [id])
  duration   Int       // milliseconds
  ip         String?
  userAgent  String?
  timestamp  DateTime  @default(now())
  
  @@index([userId])
  @@index([timestamp])
  @@index([statusCode])
}